<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />
    <title>横版平台跳跃打怪</title>
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="hud-tip">
      移动: A/D 或 ←/→ | 跳跃: Space/W/↑ | 下蹲: S/↓ | 攻击: J | 互动: E
    </div>
    <canvas id="game" width="960" height="540"></canvas>
    <script>
      (() => {
        const APP_VERSION = "2026.02.13.3";
        const APP_UPDATED_AT = "2026-02-13 14:55:43 +0800";
        const VERSION_FILE = "version.json";
        const VERSION_STORAGE_KEY = "platformer_latest_version";
        const RELOAD_ATTEMPTS_KEY = "platformer_force_reload_attempts";
        const MAX_FORCE_RELOAD_ATTEMPTS = 3;

        const loadGame = (meta = {}) => {
          window.__GAME_META__ = {
            version: meta.version || APP_VERSION,
            updatedAt: meta.updatedAt || APP_UPDATED_AT
          };
          const script = document.createElement("script");
          script.src = `game.js?v=${encodeURIComponent(APP_VERSION)}`;
          document.body.appendChild(script);
        };

        const forceReload = (targetVersion) => {
          const attempts = Number(sessionStorage.getItem(RELOAD_ATTEMPTS_KEY) || "0");
          if (attempts >= MAX_FORCE_RELOAD_ATTEMPTS) {
            loadGame();
            return;
          }
          sessionStorage.setItem(RELOAD_ATTEMPTS_KEY, String(attempts + 1));
          const nextUrl = new URL(window.location.href);
          nextUrl.searchParams.set("v", targetVersion);
          nextUrl.searchParams.set("_r", String(Date.now()));
          window.location.replace(nextUrl.toString());
        };

        fetch(`${VERSION_FILE}?_=${Date.now()}`, { cache: "no-store" })
          .then((res) => (res.ok ? res.json() : null))
          .then((data) => {
            const latestVersion =
              data && typeof data.version === "string" ? data.version : APP_VERSION;
            const latestUpdatedAt =
              data && typeof data.updatedAt === "string" ? data.updatedAt : APP_UPDATED_AT;
            localStorage.setItem(VERSION_STORAGE_KEY, latestVersion);

            if (latestVersion !== APP_VERSION) {
              forceReload(latestVersion);
              return;
            }

            sessionStorage.removeItem(RELOAD_ATTEMPTS_KEY);
            loadGame({ version: latestVersion, updatedAt: latestUpdatedAt });
          })
          .catch(() => {
            loadGame({ version: APP_VERSION, updatedAt: APP_UPDATED_AT });
          });
      })();
    </script>
  </body>
</html>
